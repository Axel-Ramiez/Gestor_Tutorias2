DROP DATABASE IF EXISTS gestion_tutorias;
CREATE DATABASE gestion_tutorias;
USE gestion_tutorias;

-- 1. Primero las tablas que NO dependen de nadie (CatÃ¡logos)
CREATE TABLE `facultad` (
  `id_facultad` int NOT NULL AUTO_INCREMENT,
  `nombre` varchar(100) NOT NULL,
  PRIMARY KEY (`id_facultad`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `rol` (
  `id_rol` int NOT NULL AUTO_INCREMENT,
  `nombre_rol` varchar(50) NOT NULL,
  PRIMARY KEY (`id_rol`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `periodo_escolar` (
  `id_periodo` int NOT NULL AUTO_INCREMENT,
  `nombre` varchar(50) NOT NULL,
  `fecha_inicio` date NOT NULL,
  `fecha_fin` date NOT NULL,
  `activo` tinyint(1) DEFAULT '0',
  PRIMARY KEY (`id_periodo`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- 2. Tablas que dependen de las anteriores
CREATE TABLE `usuario` (
  `id_usuario` int NOT NULL AUTO_INCREMENT,
  `noPersonal` varchar(20) NOT NULL,
  `contrasena` varchar(255) NOT NULL,
  `nombre` varchar(150) NOT NULL,
  `apellidoPaterno` varchar(150) NOT NULL, -- Corregido: apeliido -> apellido
  `apellidoMaterno` varchar(150) NOT NULL,
  `correo` varchar(100) DEFAULT NULL,
  `id_rol` int NOT NULL,
  `activo` tinyint(1) DEFAULT '1',
  PRIMARY KEY (`id_usuario`),
  UNIQUE KEY `noPersonal` (`noPersonal`),
  KEY `id_rol` (`id_rol`),
  CONSTRAINT `usuario_ibfk_1` FOREIGN KEY (`id_rol`) REFERENCES `rol` (`id_rol`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `carrera` (
  `id_carrera` int NOT NULL AUTO_INCREMENT,
  `nombre` varchar(100) NOT NULL,
  `id_facultad` int NOT NULL,
  PRIMARY KEY (`id_carrera`),
  KEY `id_facultad` (`id_facultad`),
  CONSTRAINT `carrera_ibfk_1` FOREIGN KEY (`id_facultad`) REFERENCES `facultad` (`id_facultad`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- 3. Tablas que dependen de Usuario y Carrera
CREATE TABLE `estudiante` (
  `id_estudiante` int NOT NULL AUTO_INCREMENT,
  `matricula` varchar(20) NOT NULL,
  `nombre` varchar(150) NOT NULL,
  `apellidoPaterno` varchar(150) NOT NULL, -- Corregido: apeliido -> apellido
  `apellidoMaterno` varchar(150) NOT NULL,
  `correo` varchar(100) DEFAULT NULL,
  `id_carrera` int NOT NULL,
  `semestre` int DEFAULT '1',
  `activo` tinyint(1) DEFAULT '1',
  `riesgo` tinyint(1) DEFAULT '1',
  `id_tutor` int DEFAULT NULL,
  PRIMARY KEY (`id_estudiante`),
  UNIQUE KEY `matricula` (`matricula`),
  KEY `id_carrera` (`id_carrera`),
  KEY `fk_estudiante_tutor` (`id_tutor`),
  CONSTRAINT `estudiante_ibfk_1` FOREIGN KEY (`id_carrera`) REFERENCES `carrera` (`id_carrera`),
  CONSTRAINT `fk_estudiante_tutor` FOREIGN KEY (`id_tutor`) REFERENCES `usuario` (`id_usuario`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- 4. Tablas transaccionales (Horarios, Reportes)
CREATE TABLE `horario_tutoria` (
  `id_horario` int NOT NULL AUTO_INCREMENT,
  `id_tutor` int NOT NULL,
  `id_estudiante` int DEFAULT NULL,
  `fecha_tutoria` date NOT NULL,
  `hora_inicio` time NOT NULL,
  `hora_fin` time NOT NULL,
  PRIMARY KEY (`id_horario`),
  KEY `id_tutor` (`id_tutor`),
  KEY `id_estudiante` (`id_estudiante`),
  CONSTRAINT `horario_tutoria_ibfk_1` FOREIGN KEY (`id_tutor`) REFERENCES `usuario` (`id_usuario`),
  CONSTRAINT `horario_tutoria_ibfk_3` FOREIGN KEY (`id_estudiante`) REFERENCES `estudiante` (`id_estudiante`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `reporte_tutoria` (
  `id_reporteTutoria` int NOT NULL AUTO_INCREMENT,
  `id_usuario` int NOT NULL,
  `id_estudiante` int NOT NULL,
  `fecha_tutoria` date NOT NULL,
  `reporte` text NOT NULL,
  `respuesta_coordinador` text,
  `asistencia` tinyint(1) DEFAULT '0',
  `estado` enum('Pendiente','Revisado') NOT NULL DEFAULT 'Pendiente',
  PRIMARY KEY (`id_reporteTutoria`), -- Corregido: Coincide con la columna
  KEY `id_usuario` (`id_usuario`),    -- Corregido: Coincide con la columna
  KEY `id_estudiante` (`id_estudiante`),
  CONSTRAINT `reporte_tutoria_ibfk_1` FOREIGN KEY (`id_usuario`) REFERENCES `usuario` (`id_usuario`),
  CONSTRAINT `reporte_tutoria_ibfk_2` FOREIGN KEY (`id_estudiante`) REFERENCES `estudiante` (`id_estudiante`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- 5. Tablas finales
CREATE TABLE `problematica` (
  `id_problematica` int NOT NULL AUTO_INCREMENT,
  `id_reporteTutoria` int NOT NULL,
  `titulo` varchar(100) NOT NULL,
  `descripcion` text NOT NULL,
  `id_carrera` int DEFAULT NULL,
  `estado` enum('Pendiente','Atendida') NOT NULL DEFAULT 'Pendiente',
  PRIMARY KEY (`id_problematica`),
  KEY `id_reporteTutoria` (`id_reporteTutoria`), -- Corregido: Coincide con la columna
  CONSTRAINT `problematica_ibfk_1` FOREIGN KEY (`id_reporteTutoria`) REFERENCES `reporte_tutoria` (`id_reporteTutoria`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
