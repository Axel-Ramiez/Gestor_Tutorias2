drop database IF EXIST gestion_tutorias;

create database gestion_tutorias;
use gestion_tutorias;

CREATE TABLE rol (
  id_rol int NOT NULL AUTO_INCREMENT,
  nombre_rol varchar(50) NOT NULL,
  PRIMARY KEY (id_rol)
);

CREATE TABLE facultad (
  id_facultad int NOT NULL AUTO_INCREMENT,
  nombre varchar(100) NOT NULL,
  PRIMARY KEY (id_facultad)
);

CREATE TABLE carrera (
  id_carrera int NOT NULL AUTO_INCREMENT,
  nombre varchar(100) NOT NULL,
  id_facultad int NOT NULL,
  PRIMARY KEY (id_carrera),
  FOREIGN KEY (id_facultad) REFERENCES facultad (id_facultad)
);

CREATE TABLE periodo_escolar (
  id_periodo int NOT NULL AUTO_INCREMENT,
  nombre varchar(50) NOT NULL,
  fecha_inicio date NOT NULL,
  fecha_fin date NOT NULL,
  activo tinyint(1) DEFAULT '0',
  PRIMARY KEY (id_periodo)
);

CREATE TABLE usuario (
  id_usuario int NOT NULL AUTO_INCREMENT,
  matricula varchar(20) NOT NULL,
  contrasena varchar(255) NOT NULL,
  nombre_completo varchar(150) NOT NULL,
  correo varchar(100) DEFAULT NULL,
  id_rol int NOT NULL,
  activo tinyint(1) DEFAULT '1',
  PRIMARY KEY (id_usuario),
  UNIQUE KEY matricula (matricula),
  FOREIGN KEY (id_rol) REFERENCES rol (id_rol)
);


CREATE TABLE estudiante (
  id_estudiante int NOT NULL AUTO_INCREMENT,
  matricula varchar(20) NOT NULL,
  nombre_completo varchar(150) NOT NULL,
  correo varchar(100) DEFAULT NULL,
  id_carrera int NOT NULL,
  semestre int DEFAULT 1,
  activo tinyint(1) DEFAULT '1',
  riesgo tinyint(1) DEFAULT '1',
  PRIMARY KEY (id_estudiante),
  UNIQUE KEY matricula (matricula),
  FOREIGN KEY (id_carrera) REFERENCES carrera (id_carrera)
);


CREATE TABLE asignacion_tutor (
  id_asignacion int NOT NULL AUTO_INCREMENT,
  id_tutor int NOT NULL,
  id_estudiante int NOT NULL,
  id_periodo int NOT NULL,
  PRIMARY KEY (id_asignacion),
  FOREIGN KEY (id_tutor) REFERENCES usuario (id_usuario),
  FOREIGN KEY (id_estudiante) REFERENCES estudiante (id_estudiante),
  FOREIGN KEY (id_periodo) REFERENCES periodo_escolar (id_periodo)
);

CREATE TABLE planeacion_tutoria (
  id_fecha_tutoria int NOT NULL AUTO_INCREMENT,
  id_periodo int NOT NULL,
  id_carrera int NOT NULL,
  fecha date NOT NULL,
  numero_sesion int NOT NULL, -- 1, 2, 3
  temas text NOT NULL,
  PRIMARY KEY (id_fecha_tutoria),
  FOREIGN KEY (id_periodo) REFERENCES periodo_escolar (id_periodo),
  FOREIGN KEY (id_carrera) REFERENCES carrera (id_carrera)
);

CREATE TABLE horario_tutoria (
  id_horario int NOT NULL AUTO_INCREMENT,
  id_tutor int NOT NULL,
  id_fecha_tutoria int NOT NULL,
  id_estudiante int DEFAULT NULL, -- NULL = Libre, CON ID = Ocupado
  hora_inicio time NOT NULL,
  hora_fin time NOT NULL,
  PRIMARY KEY (id_horario),
  FOREIGN KEY (id_tutor) REFERENCES usuario (id_usuario),
  FOREIGN KEY (id_fecha_tutoria) REFERENCES planeacion_tutoria (id_fecha_tutoria),
  FOREIGN KEY (id_estudiante) REFERENCES estudiante (id_estudiante)
);


CREATE TABLE reporte_tutoria (
  id_reporte int NOT NULL AUTO_INCREMENT,
  id_tutor int NOT NULL,
  id_estudiante int NOT NULL,
  id_fecha_tutoria int NOT NULL,
  reporte text NOT NULL,
  respuesta_coordinador text,
  asistencia tinyint(1) DEFAULT '0',
  estado ENUM('Pendiente', 'Revisado') NOT NULL DEFAULT 'Pendiente',
  PRIMARY KEY (id_reporte),
  FOREIGN KEY (id_tutor) REFERENCES usuario (id_usuario),
  FOREIGN KEY (id_estudiante) REFERENCES estudiante (id_estudiante),
  -- Esta es la línea que "comunica" el reporte con la planeación (y por ende, con sus temas)
  FOREIGN KEY (id_fecha_tutoria) REFERENCES planeacion_tutoria (id_fecha_tutoria)
) ENGINE=InnoDB;


CREATE TABLE problematica (
  id_problematica int NOT NULL AUTO_INCREMENT,
  id_reporte int NOT NULL,
  titulo varchar(100) NOT NULL,
  descripcion text NOT NULL,
  id_experiencia_educativa int DEFAULT NULL,
  estado ENUM('Pendiente', 'Atendida') NOT NULL DEFAULT 'Pendiente',
  PRIMARY KEY (id_problematica),
  FOREIGN KEY (id_reporte) REFERENCES reporte_tutoria (id_reporte)
);


INSERT INTO rol (nombre_rol) VALUES
('Administrador'),
('Coordinador'),
('Tutor');


INSERT INTO facultad (nombre) VALUES
('Estadística e Informática'),
('Ingeniería'),
('Derecho'),
('Medicina');


INSERT INTO carrera (nombre, id_facultad) VALUES
('Ingeniería de Software', 1),
('Redes y Servicios de Cómputo', 1),
('Estadística', 1),
('Ingeniería Civil', 2);


INSERT INTO periodo_escolar (nombre, fecha_inicio, fecha_fin, activo) VALUES
('FEB-JUL 2024', '2024-02-06', '2024-07-15', 0),
('AGO-ENE 2024', '2024-08-12', '2025-01-31', 1);


INSERT INTO usuario (matricula, contrasena, nombre_completo, correo, id_rol, activo) VALUES
('ADM001', '12345', 'Carlos Administrador', 'admin@uv.mx', 1, 1),
('COR001', '12345', 'Laura Coordinadora', 'lcoord@uv.mx', 2, 1),
('PRO001', '12345', 'Juan Pérez Tutor', 'jperez@uv.mx', 3, 1),
('PRO002', '12345', 'Maria Gomez Tutor', 'mgomez@uv.mx', 3, 1);


INSERT INTO estudiante (matricula, nombre_completo, correo, id_carrera, semestre, activo, riesgo) VALUES
('zS20015001', 'Ana Martinez', 'zs20015001@estudiantes.uv.mx', 1, 3, 1, 0),
('zS20015002', 'Luis Rodriguez', 'zs20015002@estudiantes.uv.mx', 1, 5, 1, 1),
('zS20015003', 'Pedro Sanchez', 'zs20015003@estudiantes.uv.mx', 2, 1, 1, 0),
('zS20015004', 'Sofia Torres', 'zs20015004@estudiantes.uv.mx', 1, 7, 1, 1);

INSERT INTO asignacion_tutor (id_tutor, id_estudiante, id_periodo) VALUES
(3, 1, 2), -- Juan Pérez atiende a Ana Martinez
(3, 2, 2), -- Juan Pérez atiende a Luis Rodriguez
(4, 3, 2), -- Maria Gomez atiende a Pedro Sanchez
(4, 4, 2); -- Maria Gomez atiende a Sofia Torres

INSERT INTO planeacion_tutoria (id_periodo, id_carrera, fecha, numero_sesion, temas) VALUES
(2, 1, '2024-09-05', 1, 'Presentación, revisión de carga académica y lineamientos.'),
(2, 1, '2024-10-20', 2, 'Seguimiento de calificaciones parciales y apoyo académico.'),
(2, 1, '2024-12-01', 3, 'Evaluación final del periodo y preparación de pre-inscripción.');

INSERT INTO horario_tutoria (id_tutor, id_fecha_tutoria, id_estudiante, hora_inicio, hora_fin) VALUES
(3, 1, 1, '10:00:00', '10:15:00'), -- Slot ocupado por Ana Martinez
(3, 1, 2, '10:15:00', '10:30:00'), -- Slot ocupado por Luis Rodriguez
(3, 1, NULL, '10:30:00', '10:45:00'), -- Slot libre
(4, 1, 3, '11:00:00', '11:15:00'); -- Slot ocupado por Pedro Sanchez

INSERT INTO reporte_tutoria (id_tutor, id_estudiante, id_fecha_tutoria, descripcion_general, asistencia, estado) VALUES
(3, 1, 1, 'La estudiante muestra buen desempeño, sin dudas administrativas.', 1, 'Revisado'),
(3, 2, 1, 'El estudiante comenta dificultades en una experiencia educativa específica.', 1, 'Pendiente');

INSERT INTO problematica (id_reporte, titulo, descripcion, id_experiencia_educativa, estado) VALUES
(2, 'Dificultad con Algoritmos', 'El estudiante no comprende los conceptos de recursividad.', 101, 'Pendiente'),
(2, 'Falta de equipo de cómputo', 'El estudiante requiere acceso a laboratorios fuera de horario.', NULL, 'Atendida');
